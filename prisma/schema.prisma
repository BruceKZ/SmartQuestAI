generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id          String   @id @default(uuid())
  email       String   @unique
  avatar_url  String?
  api_keys    Json?    // Encrypted JSON: { openai: "...", gemini: "..." }
  settings    Json?    // { default_language: "en", theme: "system" }
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  questions   Question[]
  submissions Submission[]
  exam_sessions ExamSession[]
  source_files SourceFile[]
  problem_lists ProblemList[]
}

model Question {
  id            String         @id @default(uuid())
  content       String         // Markdown + LaTeX
  type          QuestionType
  options       Json?          // [{id: "A", content: "..."}]
  answer        Json?          // Correct Answer structure
  explanation   String?        // Markdown
  difficulty    Int            @default(1) // 1-5
  status        QuestionStatus @default(REVIEW)
  parent_pdf_id String?
  created_at    DateTime       @default(now())
  updated_at    DateTime       @updatedAt

  parent_pdf    SourceFile?    @relation(fields: [parent_pdf_id], references: [id])
  tags          Tag[]
  problem_lists ProblemList[]
  submissions   Submission[]
  author_id     String
  author        User           @relation(fields: [author_id], references: [id])
}

model SourceFile {
  id          String   @id @default(uuid())
  filename    String
  url         String
  uploaded_at DateTime @default(now())
  user_id     String
  user        User     @relation(fields: [user_id], references: [id])
  questions   Question[]
}

model Tag {
  id        String     @id @default(uuid())
  name      String     @unique
  questions Question[]
}

model ProblemList {
  id          String     @id @default(uuid())
  title       String
  description String?
  is_public   Boolean    @default(false)
  created_at  DateTime   @default(now())
  user_id     String
  user        User       @relation(fields: [user_id], references: [id])
  questions   Question[]
}

model ExamSession {
  id            String     @id @default(uuid())
  status        ExamStatus @default(ACTIVE)
  timer_seconds Int        @default(0)
  answers_json  Json?      // User's current answers
  started_at    DateTime   @default(now())
  ended_at      DateTime?
  user_id       String
  user          User       @relation(fields: [user_id], references: [id])
}

model Submission {
  id          String   @id @default(uuid())
  score       Float?
  feedback    String?  // AI Grading Feedback
  answers     Json     // Final answers
  submitted_at DateTime @default(now())
  user_id     String
  user        User     @relation(fields: [user_id], references: [id])
  question_id String
  question    Question @relation(fields: [question_id], references: [id])
}

enum QuestionType {
  SINGLE
  MULTI
  SHORT
  ESSAY
}

enum QuestionStatus {
  DRAFT
  REVIEW
  PUBLISHED
}

enum ExamStatus {
  ACTIVE
  PAUSED
  FINISHED
}
